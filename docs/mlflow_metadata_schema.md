# MLflow metadata schema (select → infer)

This document defines how we name and store metadata for model selection and inference using MLflow.

## Goals
- Make runs easy to compare and filter (by dataset/timeframe/target/metric).
- Make inference safe and reproducible (stage/alias + exact config + model path).
- Keep UI clean: predictable names, minimal tags, structured params/metrics, curated artifacts.

## High level categories
- **Experiment** (group comparable runs, defined by user)
  - Purpose: group multiple runs with simliar inputs and same target, so we can compare the performance and register best models
  - Name: decided by user, should be descriptive and very human readable.

- **Run** (identifier of model training run)
  - Purpose: mark each model training run
  - Name: generated by model training script, e.g., for lgbm, it could be `run_YYYYMMDD_HHMMSS_{model_type}_{target}_{objective}`
  - Example: `run_20251008_145809_lgbm_y_logret_168h_huber`.

- **Model Registry** (for model selection and inference)
  - **Model name:** decided by user for their inference pipeline.
  - **Version description:** human summary of the model.
  - **Aliases:** `Staging` or `Production` (visible on Model → Versions).

## For each **Run**

### Params (structured; for search/filter)
Record these under MLflow “params”, sourced from model training artifact run_metadata.json:
- `model_type`: e.g., `lgbm`
- `target`: e.g., `y_logret_168h`
- `objective`: e.g., `huber` | `binary` | `tweedie`
- `primary_metric`: e.g., `rmse` | `auc`
- `dataset_slug`: sanitized dataset id, e.g., `BINANCE_BTCUSDT.P_60` (replace spaces/commas with `_`)
- `external_model_path`: absolute path to model file if not copying into MLflow
- `prepared_data_dir`: path to prepared data directory
- `output_dir`: runs root
- `feature_list_id`: e.g., `binance_btcusdt_p60_default` 

### Metrics (numeric; for comparison)
Record these under MLflow “metrics” (may add more):
- Regression: `rmse_train`, `rmse_val`, `rmse_test` (and/or `mae_*`)
- Classification: `auc_train`, `auc_val`, `auc_test` (and optionally `logloss_*`)
- Correlation: `corr_train`, `corr_val`, `corr_test`

### Tags (sparse; audit context only)
- Purpose: for quick search
- Name: decided by human, editted in web UI

### Artifacts (files from model run output dir)
Default log all files from model run output dir; 
- Example: all files under `/Volumes/Extreme SSD/trading_data/cex/models/BINANCE_BTCUSDT.P, 60/run_20251008_145809_lgbm_y_logret_168h_huber/`

## Example (lgbm regression)
- Experiment: `binance-btcusdt-perp-1h-7d-logret`
- Run: `run_20251008_145809_lgbm_y_logret_168h_huber`
- Params: `{model_type: lgbm, target: y_logret_168h, objective: huber, primary_metric: rmse, dataset_slug: BINANCE_BTCUSDT.P_60, external_model_path: /.../model.txt}, prepared_data_dir: /.../prep_data_dir, output_dir: /.../run_20251008_145809_lgbm_y_logret_168h_huber, feature_list_id: binance_btcusdt_p60_default`
- Metrics: `{rmse_train: 0.0548, rmse_val: 0.0669, rmse_test: 0.0448}`
- Tags: `{target_type: regression , hyperparam_tuning: true}`
- Artifacts: all files under `output_dir`
- Registry: Model `btcusdt-1h-inference-7d-logret` → Version description `Trained 2023-2025 data, with default features from tech indicators` → Aliases `Staging`.

### Notes
- Prefer params for structured fields from model training config or run metadata; reserve tags for human edits.
- Avoid spaces/commas in artifact root paths (use sanitized directories or symlinks).

